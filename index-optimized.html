<!DOCTYPE html>
<html lang="id">
<head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>Movie Review</title>
	<style>
		:root {
			--bg-primary: #020617;
			--bg-secondary: #030712;
			--border-primary: #1f2937;
			--border-secondary: #111827;
			--text-primary: #e5e7eb;
			--text-secondary: #9ca3af;
			--text-tertiary: #d1d5db;
			--accent: #0f766e;
			--accent-light: #14b8a6;
			--focus: #22c55e;
			color-scheme: dark;
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
			background: var(--bg-primary);
			color: var(--text-primary);
			min-height: 100vh;
			display: flex;
			align-items: stretch;
			justify-content: center;
		}

		.app {
			width: 100%;
			max-width: 960px;
			padding: 16px;
		}

		header {
			margin-bottom: 16px;
		}

		header h1 {
			font-size: 1.4rem;
			margin-bottom: 4px;
		}

		.tabs {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			margin: 16px 0;
		}

		button, input, select, textarea {
			border-radius: 999px;
			border: 1px solid var(--border-primary);
			background: var(--bg-primary);
			color: var(--text-primary);
			font-size: 0.9rem;
		}

		button {
			cursor: pointer;
			padding: 8px 12px;
		}

		button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
			outline: 2px solid var(--focus);
			outline-offset: 2px;
		}

		.tab-btn {
			flex: 1 1 120px;
			text-align: center;
			transition: background 0.15s, border-color 0.15s;
		}

		.tab-btn.active {
			background: var(--accent);
			border-color: var(--accent-light);
		}

		.content {
			border-radius: 12px;
			border: 1px solid var(--border-primary);
			padding: 12px;
			min-height: 240px;
			overflow-y: auto;
		}

		.section {
			display: none;
		}

		.section.active {
			display: block;
		}

		.status {
			font-size: 0.85rem;
			color: var(--text-secondary);
			margin-bottom: 8px;
		}

		.list {
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.card {
			padding: 8px 10px;
			border-radius: 8px;
			border: 1px solid var(--border-secondary);
			background: var(--bg-secondary);
		}

		.card-title {
			font-weight: 600;
			margin-bottom: 2px;
		}

		.card-subtitle {
			font-size: 0.8rem;
			color: var(--text-secondary);
			margin-bottom: 4px;
		}

		.card-body {
			font-size: 0.85rem;
			color: var(--text-tertiary);
		}

		.user-info {
			margin-top: 4px;
			font-size: 0.8rem;
			color: var(--text-secondary);
		}

		.auth-overlay, .movie-overlay {
			position: fixed;
			inset: 0;
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 10;
		}

		.auth-overlay {
			background: radial-gradient(circle at top, #0b1120, var(--bg-primary) 55%);
		}

		.movie-overlay {
			background: rgba(15, 23, 42, 0.92);
			display: none;
			z-index: 9;
		}

		.auth-card, .movie-card {
			width: 100%;
			padding: 16px 18px;
			border-radius: 16px;
			border: 1px solid var(--border-primary);
			background: var(--bg-primary);
		}

		.auth-card {
			max-width: 360px;
			box-shadow: 0 24px 64px rgba(0, 0, 0, 0.8);
		}

		.movie-card {
			max-width: 720px;
			max-height: 80vh;
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.auth-card h2 {
			font-size: 1.2rem;
			margin-bottom: 6px;
		}

		.auth-subtitle {
			font-size: 0.8rem;
			color: var(--text-secondary);
			margin-bottom: 12px;
		}

		.auth-label {
			font-size: 0.8rem;
			color: var(--text-secondary);
			margin-bottom: 4px;
			display: block;
		}

		input, select, textarea {
			padding: 8px 10px;
		}

		.auth-input {
			width: 100%;
			margin-bottom: 10px;
		}

		.auth-actions {
			display: flex;
			gap: 8px;
			margin-bottom: 6px;
		}

		.auth-btn {
			flex: 1;
			background: var(--accent);
		}

		.auth-btn.secondary {
			background: var(--bg-primary);
		}

		.movie-card-header {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			gap: 8px;
		}

		.movie-card-title {
			font-size: 1rem;
			font-weight: 600;
		}

		.movie-card-meta {
			font-size: 0.8rem;
			color: var(--text-secondary);
			margin-top: 2px;
		}

		.movie-card-desc {
			font-size: 0.85rem;
			color: var(--text-tertiary);
			margin-top: 6px;
		}

		.movie-reviews-list {
			margin-top: 8px;
			border-top: 1px solid var(--border-secondary);
			padding-top: 8px;
			overflow-y: auto;
			flex: 1;
		}

		.review-form {
			margin-bottom: 10px;
			padding: 8px;
			border-radius: 8px;
			border: 1px solid var(--border-secondary);
			background: var(--bg-secondary);
		}

		.review-form-row {
			display: flex;
			gap: 8px;
			margin-bottom: 6px;
		}

		.review-form-row select {
			flex: 1;
			font-size: 0.85rem;
		}

		#review-comment {
			width: 100%;
			min-height: 60px;
			resize: vertical;
			border-radius: 8px;
			font-size: 0.85rem;
		}

		#btn-submit-review {
			background: var(--accent);
		}

		@media (max-width: 480px) {
			.content { min-height: 200px; }
			.card { padding: 6px 8px; }
		}
	</style>
</head>
<body>
	<div id="auth-overlay" class="auth-overlay">
		<div class="auth-card">
			<h2>Masuk ke Movie Review</h2>
			<p class="auth-subtitle">Gunakan nama saja untuk membuat atau memilih akun.</p>
			<label for="auth-name" class="auth-label">Nama</label>
			<input id="auth-name" type="text" class="auth-input" placeholder="Nama kamu, misal: joan" autocomplete="off"/>
			<div class="auth-actions">
				<button id="btn-login" class="auth-btn secondary">Masuk</button>
				<button id="btn-register" class="auth-btn">Daftar</button>
			</div>
			<div id="status-auth" class="status">Masuk jika nama sudah terdaftar, atau daftar untuk membuat akun baru.</div>
		</div>
	</div>

	<div id="movie-overlay" class="movie-overlay">
		<div class="movie-card">
			<div class="movie-card-header">
				<div>
					<div id="movie-overlay-title" class="movie-card-title"></div>
					<div id="movie-overlay-meta" class="movie-card-meta"></div>
				</div>
				<button id="btn-close-movie">Tutup</button>
			</div>
			<div id="movie-overlay-desc" class="movie-card-desc"></div>
			<button id="btn-add-watchlist" class="auth-btn secondary" style="margin-top:8px;align-self:flex-start">Tambah ke Watchlist</button>
			<div id="movie-overlay-status" class="status"></div>
			<div id="movie-overlay-reviews" class="movie-reviews-list"></div>
		</div>
	</div>

	<div class="app">
		<header>
			<h1>Movie Review</h1>
			<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:4px">
				<div id="user-info" class="user-info">Belum login</div>
				<button id="btn-logout" class="auth-btn secondary" style="flex:0 0 auto">Keluar</button>
			</div>
		</header>

		<nav class="tabs" aria-label="Menu data">
			<button class="tab-btn active" data-tab="movies">Movies</button>
			<button class="tab-btn" data-tab="reviews">Reviews</button>
			<button class="tab-btn" data-tab="watchlist">Watchlist</button>
		</nav>

		<main class="content" aria-live="polite">
			<section id="section-movies" class="section active">
				<div class="review-form">
					<div class="review-form-row">
						<select id="review-movie">
							<option value="">-- Pilih film --</option>
						</select>
						<select id="review-rating">
							<option value="5">Rating: 5</option>
							<option value="4">Rating: 4</option>
							<option value="3">Rating: 3</option>
							<option value="2">Rating: 2</option>
							<option value="1">Rating: 1</option>
						</select>
					</div>
					<textarea id="review-comment" placeholder="Tulis review kamu di sini"></textarea>
					<button id="btn-submit-review">Kirim Review</button>
					<div id="status-review-form" class="status"></div>
				</div>
				<div id="status-movies" class="status"></div>
				<div id="list-movies" class="list"></div>
			</section>

			<section id="section-reviews" class="section">
				<div id="status-reviews" class="status"></div>
				<div id="list-reviews" class="list"></div>
			</section>

			<section id="section-watchlist" class="section">
				<div id="status-watchlist" class="status"></div>
				<div id="list-watchlist" class="list"></div>
			</section>
		</main>
	</div>

	<script>
		(function () {
			const API = {
				movies: "https://joan.tugastst.my.id/movies",
				reviews: "https://joan.tugastst.my.id/reviews",
				users: "https://huga.tugastst.my.id/users",
				watchlist: "https://huga.tugastst.my.id/watchlist"
			};

			const cache = {};
			let currentUser = null, currentOverlayMovie = null;

			const $ = id => document.getElementById(id);
			const els = {
				userInfo: $("user-info"),
				authOverlay: $("auth-overlay"),
				authName: $("auth-name"),
				movieOverlay: $("movie-overlay"),
				movieTitle: $("movie-overlay-title"),
				movieMeta: $("movie-overlay-meta"),
				movieDesc: $("movie-overlay-desc"),
				movieReviews: $("movie-overlay-reviews"),
				reviewMovie: $("review-movie"),
				reviewRating: $("review-rating"),
				reviewComment: $("review-comment")
			};

			const tabs = document.querySelectorAll(".tab-btn");
			const sections = {}, statusEls = {}, listEls = {};
			["movies", "reviews", "watchlist"].forEach(name => {
				sections[name] = $("section-" + name);
				statusEls[name] = $("status-" + name);
				listEls[name] = $("list-" + name);
			});
			statusEls.auth = $("status-auth");
			statusEls.movieReviews = $("movie-overlay-status");
			statusEls.reviewForm = $("status-review-form");

			const normalizeName = v => (v || "").toString().trim().toLowerCase();
			const truncate = (s, max) => s && s.length > max ? s.slice(0, max - 1) + "…" : s || "";
			const formatMeta = m => `Tahun ${m.year || "-"} • Rating ${m.rating ?? "-"}${Array.isArray(m.genre) ? " • " + m.genre.join(", ") : m.genre ? " • " + m.genre : ""}`;
			const normalizeData = d => Array.isArray(d) ? d : Array.isArray(d?.data) ? d.data : [];

			const openMovieOverlay = movie => {
				currentOverlayMovie = movie;
				els.movieTitle.textContent = movie.title || "(Tanpa judul)";
				els.movieMeta.textContent = formatMeta(movie);
				els.movieDesc.textContent = movie.description || "";
				statusEls.movieReviews.textContent = "";
				els.movieReviews.innerHTML = "";
				els.movieOverlay.style.display = "flex";
			};

			const closeMovieOverlay = () => {
				els.movieOverlay.style.display = "none";
				currentOverlayMovie = null;
			};

			const updateUserInfo = () => {
				els.userInfo.textContent = currentUser ? "Masuk sebagai " + currentUser.name : "Belum login";
			};

			const showAuth = () => {
				els.authOverlay.style.display = "flex";
				els.authName.focus();
			};

			const hideAuth = () => els.authOverlay.style.display = "none";

			const loadUserFromStorage = () => {
				try {
					const raw = localStorage.getItem("mh_user");
					if (raw) {
						const parsed = JSON.parse(raw);
						if (parsed?.id && parsed?.name) currentUser = parsed;
					}
				} catch (e) { }
				updateUserInfo();
				currentUser ? hideAuth() : showAuth();
			};

			const setActiveTab = name => {
				tabs.forEach(btn => btn.classList.toggle("active", btn.dataset.tab === name));
				Object.keys(sections).forEach(key => sections[key].classList.toggle("active", key === name));
			};

			const safeFetch = async (url, name) => {
				try {
					const res = await fetch(url, { cache: "no-store" });
					if (!res.ok) throw new Error("Status " + res.status);
					return await res.json();
				} catch (err) {
					if (statusEls[name]) statusEls[name].textContent = "Gagal mengambil data (" + err.message + "). Coba lagi.";
					return null;
				}
			};

			const createCard = (title, subtitle, body) => {
				const card = document.createElement("div");
				card.className = "card";
				card.innerHTML = `<div class="card-title">${title}</div>${subtitle ? `<div class="card-subtitle">${subtitle}</div>` : ""}${body ? `<div class="card-body">${body}</div>` : ""}`;
				return card;
			};

			const renderMovies = movies => {
				const container = listEls.movies;
				container.innerHTML = "";
				if (!Array.isArray(movies) || !movies.length) {
					container.textContent = "Tidak ada film.";
					return;
				}

				movies.forEach(movie => {
					const card = createCard(
						movie.title || "(Tanpa judul)",
						formatMeta(movie) + (movie.director ? "<br>Director: " + movie.director : ""),
						movie.description || ""
					);
					card.style.cursor = "pointer";
					card.addEventListener("click", async () => {
						if (!movie.id) return;
						openMovieOverlay(movie);
						statusEls.movieReviews.textContent = "Memuat review untuk film ini...";
						const data = await safeFetch(API.reviews + "/movie/" + encodeURIComponent(movie.id), "movieReviews");
						if (data) {
							const items = normalizeData(data);
							statusEls.movieReviews.textContent = items.length ? `Menampilkan ${items.length} review.` : "Belum ada review untuk film ini.";
							renderMovieOverlayReviews(items);
						}
					});
					container.appendChild(card);
				});
			};

			const renderReviews = reviews => {
				const container = listEls.reviews;
				container.innerHTML = "";
				if (!Array.isArray(reviews) || !reviews.length) {
					container.textContent = "Belum ada review.";
					return;
				}

				reviews.forEach(rev => {
					container.appendChild(createCard(
						rev.username || "User " + (rev.userId || "-"),
						`Rating ${rev.rating ?? "-"} • Movie ID ${rev.movieId ?? "-"}`,
						truncate(rev.comment || "", 160)
					));
				});
			};

			const renderMovieOverlayReviews = reviews => {
				els.movieReviews.innerHTML = "";
				if (!Array.isArray(reviews) || !reviews.length) {
					els.movieReviews.textContent = "Belum ada review untuk film ini.";
					return;
				}

				reviews.forEach(rev => {
					els.movieReviews.appendChild(createCard(
						rev.username || "User " + (rev.userId || "-"),
						"Rating " + (rev.rating ?? "-"),
						truncate(rev.comment || "", 160)
					));
				});
			};

			const renderWatchlist = items => {
				const container = listEls.watchlist;
				container.innerHTML = "";
				if (!Array.isArray(items) || !items.length) {
					container.textContent = "Belum ada film di watchlist.";
					return;
				}

				items.forEach(entry => {
					const movie = entry.movie || {};
					container.appendChild(createCard(
						movie.title || "Film ID " + (entry.movieId || "-"),
						formatMeta(movie),
						truncate(movie.description || "", 180)
					));
				});
			};

			const populateReviewMovieSelect = movies => {
				const prev = els.reviewMovie.value;
				els.reviewMovie.innerHTML = '<option value="">-- Pilih film --</option>';
				if (Array.isArray(movies)) {
					movies.forEach(m => {
						const opt = document.createElement("option");
						opt.value = m.id;
						opt.textContent = m.title || `Film (#${m.id})`;
						els.reviewMovie.appendChild(opt);
					});
				}
				if (prev && Array.from(els.reviewMovie.options).some(o => o.value === prev)) {
					els.reviewMovie.value = prev;
				}
			};

			const loadMoviesIfNeeded = async () => {
				if (cache.movies) return;
				const data = await safeFetch(API.movies, "movies");
				if (data) {
					cache.movies = normalizeData(data);
					renderMovies(cache.movies);
					populateReviewMovieSelect(cache.movies);
				}
			};

			const loadReviewsIfNeeded = async () => {
				if (Array.isArray(cache.reviews)) {
					renderReviews(cache.reviews);
					return;
				}
				const data = await safeFetch(API.reviews, "reviews");
				if (data) {
					cache.reviews = normalizeData(data);
					renderReviews(cache.reviews);
				}
			};

			const loadWatchlistForCurrentUser = async () => {
				if (!currentUser) {
					statusEls.watchlist.textContent = "Masuk dulu untuk melihat watchlist.";
					showAuth();
					return;
				}

				statusEls.watchlist.textContent = "Memuat watchlist...";
				const data = await safeFetch(API.watchlist + "/" + encodeURIComponent(currentUser.id), "watchlist");
				if (!data) return;

				await loadMoviesIfNeeded();
				const movies = cache.movies || [];
				cache.watchlist = normalizeData(data).map(entry => ({
					userId: entry.userId,
					movieId: entry.movieId,
					movie: movies.find(m => String(m.id) === String(entry.movieId)) || null
				}));
				statusEls.watchlist.textContent = "";
				renderWatchlist(cache.watchlist);
			};

			const addCurrentMovieToWatchlist = async () => {
				if (!currentOverlayMovie?.id) return;
				if (!currentUser) {
					statusEls.movieReviews.textContent = "Masuk dulu untuk menambahkan ke watchlist.";
					showAuth();
					return;
				}

				statusEls.movieReviews.textContent = "Menambahkan ke watchlist...";
				try {
					const res = await fetch(API.watchlist, {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ userId: currentUser.id, movieId: String(currentOverlayMovie.id) })
					});
					if (!res.ok) throw new Error("Status " + res.status);
					statusEls.movieReviews.textContent = "Berhasil ditambahkan ke watchlist.";
					if (sections.watchlist?.classList.contains("active")) loadWatchlistForCurrentUser();
				} catch (err) {
					statusEls.movieReviews.textContent = "Gagal menambahkan ke watchlist (" + err.message + ").";
				}
			};

			const handleAuth = async (isLogin) => {
				const name = (els.authName.value || "").trim();
				if (!name) {
					statusEls.auth.textContent = "Nama tidak boleh kosong.";
					return;
				}

				if (isLogin) {
					const data = await safeFetch(API.users, "auth");
					if (!data) return;
					const items = normalizeData(data);
					const found = items.find(u => normalizeName(u.name || u.username) === normalizeName(name));

					if (!found) {
						statusEls.auth.textContent = "User tidak ditemukan. Coba daftar dulu.";
						return;
					}

					currentUser = { id: found.id, name: found.name || found.username || name };
					try { localStorage.setItem("mh_user", JSON.stringify(currentUser)); } catch (e) { }
					statusEls.auth.textContent = "Berhasil masuk sebagai " + currentUser.name + ".";
				} else {
					statusEls.auth.textContent = "Mendaftarkan user...";
					try {
						const res = await fetch(API.users, {
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify({ name })
						});
						if (!res.ok) throw new Error("Status " + res.status);
						let body = await res.json().catch(() => null);
						let created = body?.data || body;

						if (!created?.id) {
							const dataUsers = await safeFetch(API.users, "auth");
							created = normalizeData(dataUsers).find(u => normalizeName(u.name || u.username) === normalizeName(name));
						}

						if (!created) {
							statusEls.auth.textContent = "Pendaftaran berhasil, tapi data user belum terbaca. Coba masuk ulang.";
							return;
						}

						currentUser = { id: created.id, name: created.name || created.username || name };
						try { localStorage.setItem("mh_user", JSON.stringify(currentUser)); } catch (e) { }
						statusEls.auth.textContent = "Berhasil daftar dan masuk sebagai " + currentUser.name + ".";
					} catch (err) {
						statusEls.auth.textContent = "Gagal mendaftarkan user (" + err.message + ").";
						return;
					}
				}
				updateUserInfo();
				setTimeout(hideAuth, 600);
			};

			const submitReview = async () => {
				if (!currentUser) {
					statusEls.reviewForm.textContent = "Kamu harus login dulu sebelum mengirim review.";
					showAuth();
					return;
				}

				const movieId = els.reviewMovie.value;
				const rating = els.reviewRating.value;
				const comment = (els.reviewComment.value || "").trim();

				if (!movieId) {
					statusEls.reviewForm.textContent = "Pilih film terlebih dahulu.";
					return;
				}

				statusEls.reviewForm.textContent = "Mengirim review...";
				try {
					const res = await fetch(API.reviews, {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							movieId: Number(movieId),
							userId: currentUser.id,
							username: currentUser.name,
							rating: Number(rating),
							comment
						})
					});
					if (!res.ok) throw new Error("Status " + res.status);
					const body = await res.json().catch(() => null);
					const created = body?.data || body;

					statusEls.reviewForm.textContent = "Review berhasil dikirim.";
					els.reviewComment.value = "";
					els.reviewRating.value = "5";

					if (created) {
						cache.reviews = [created, ...(cache.reviews || [])];
						renderReviews(cache.reviews);
						statusEls.reviews.textContent = "Review terbaru sudah ditambahkan.";
					}
				} catch (err) {
					statusEls.reviewForm.textContent = "Gagal mengirim review (" + err.message + ").";
				}
			};

			const handleLogout = () => {
				currentUser = null;
				try { localStorage.removeItem("mh_user"); } catch (e) { }
				updateUserInfo();
				statusEls.reviewForm.textContent = "";
				cache.watchlist = null;
				listEls.watchlist.innerHTML = "";
				statusEls.watchlist.textContent = "";
				showAuth();
			};

			tabs.forEach(btn => {
				btn.addEventListener("click", () => {
					const tabName = btn.dataset.tab;
					setActiveTab(tabName);
					if (tabName === "movies") loadMoviesIfNeeded();
					else if (tabName === "reviews") loadReviewsIfNeeded();
					else if (tabName === "watchlist") loadWatchlistForCurrentUser();
				});
			});

			$("btn-submit-review")?.addEventListener("click", submitReview);
			$("btn-login")?.addEventListener("click", () => handleAuth(true));
			$("btn-register")?.addEventListener("click", () => handleAuth(false));
			$("btn-logout")?.addEventListener("click", handleLogout);
			$("btn-close-movie")?.addEventListener("click", closeMovieOverlay);
			$("btn-add-watchlist")?.addEventListener("click", addCurrentMovieToWatchlist);
			els.authName?.addEventListener("keyup", e => e.key === "Enter" && handleAuth(true));

			loadMoviesIfNeeded();
			loadUserFromStorage();
		})();
	</script>
</body>
</html>
